<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.3.xsd"
        objectQuotingStrategy="QUOTE_ONLY_RESERVED_WORDS">
    <!-- Only a handful of db systems can do deferrable, 2 versions. -->
    <changeSet id="Add TimeSeriesValue FK v2 - Time Series (deferred)"
               author="Christopher Tubbs, Jesse Bickel"
               dbms="oracle,postgresql,sqlite">
        <preConditions onFail="MARK_RAN">
            <not>
                <foreignKeyConstraintExists foreignKeyName="timeseriesvalue_timeseries_fk"
                                            foreignKeyTableName="TimeSeriesValue"
                                            schemaName="wres" />
            </not>
        </preConditions>
        <addForeignKeyConstraint constraintName="timeseriesvalue_timeseries_fk"
                                 baseColumnNames="timeseries_id"
                                 baseTableName="TimeSeriesValue"
                                 baseTableSchemaName="wres"
                                 referencedColumnNames="timeseries_id"
                                 referencedTableName="TimeSeries"
                                 referencedTableSchemaName="wres"
                                 initiallyDeferred="true"
                                 deferrable="true"
                                 onDelete="CASCADE" />
        <comment>Linked wres.TimeSeriesValue to wres.TimeSeries</comment>
    </changeSet>

    <!-- In the db where initiallyDeferred is not supported use this one.
         In the odd/rare case of sybase (doesn't support onDelete=CASCADE),
         live without the FK constraint. -->
    <changeSet id="Add TimeSeriesValue FK v2 - Time Series (deferred)"
               author="Christopher Tubbs, Jesse Bickel"
               dbms="!oracle,!postgresql,!sqlite,!sybase">
        <preConditions onFail="MARK_RAN">
            <not>
                <foreignKeyConstraintExists foreignKeyName="timeseriesvalue_timeseries_fk"
                                            foreignKeyTableName="TimeSeriesValue"
                                            schemaName="wres" />
            </not>
        </preConditions>
        <addForeignKeyConstraint constraintName="timeseriesvalue_timeseries_fk"
                                 baseColumnNames="timeseries_id"
                                 baseTableName="TimeSeriesValue"
                                 baseTableSchemaName="wres"
                                 referencedColumnNames="timeseries_id"
                                 referencedTableName="TimeSeries"
                                 referencedTableSchemaName="wres"
                                 onDelete="CASCADE" />
        <comment>Linked wres.TimeSeriesValue to wres.TimeSeries</comment>
    </changeSet>

    <changeSet id="Add TimeSeriesValue Index - Time Series" author="Christopher Tubbs">
        <preConditions onFail="MARK_RAN">
            <not>
                <indexExists schemaName="wres" tableName="TimeSeriesValue"
                             columnNames="timeseries_id" indexName="timeseriesvalue_timeseries_idx" />
            </not>
        </preConditions>
        <createIndex schemaName="wres" tableName="TimeSeriesValue" indexName="timeseriesvalue_timeseries_idx">
            <column name="timeseries_id"/>
        </createIndex>
        <comment>Added an index on wres.TimeSeriesValue.timeseries_id</comment>
    </changeSet>
    <changeSet id="Add UnitConversion Index - MeasurementUnit" author="">
        <preConditions onFail="MARK_RAN">
            <not>
                <indexExists schemaName="wres" tableName="UnitConversion"
                             columnNames="from_unit,to_unit" indexName="unitconversion_measurement_uix" />
            </not>
        </preConditions>
        <createIndex tableName="UnitConversion" schemaName="wres" indexName="unitconversion_measurement_uix" unique="true">
            <column name="from_unit" type="smallint" />
            <column name="to_unit" type="smallint" />
        </createIndex>
        <comment>Added an index on wres.UnitConversion to_unit and from_unit</comment>
    </changeSet>
</databaseChangeLog>
