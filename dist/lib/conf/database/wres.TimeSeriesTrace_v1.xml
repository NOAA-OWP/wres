<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.7.xsd"
                   objectQuotingStrategy="QUOTE_ONLY_RESERVED_WORDS">
    <changeSet id="Remove project and source data if old wres.TimeSeries exists, non-pg db."
               author="Jesse Bickel"
               dbms="!postgresql">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="TimeSeries" schemaName="wres" />

            <!-- Suppose a new wres.TimeSeries replaces wres.Source, it would
                 not have source_id and would not have ensemble_id in it. -->
            <columnExists columnName="source_id" tableName="TimeSeries"
                          schemaName="wres" />
            <columnExists columnName="ensemble_id" tableName="TimeSeries"
                          schemaName="wres" />
            <tableExists tableName="Project" schemaName="wres" />
            <tableExists tableName="Source" schemaName="wres" />
            <tableExists tableName="SourceCompleted" schemaName="wres" />
        </preConditions>
        <delete tableName="Project" schemaName="wres" />
        <delete tableName="Source" schemaName="wres" />

        <!-- This should cascade from wres.Source, but just to be sure... -->
        <delete tableName="SourceCompleted" schemaName="wres" />
    </changeSet>
    <changeSet id="Remove project and source data if old wres.TimeSeries exists, pg db."
               author="Jesse Bickel"
               dbms="postgresql">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="TimeSeries" schemaName="wres" />

            <!-- Suppose a new wres.TimeSeries replaces wres.Source, it would
                 not have source_id and would not have ensemble_id in it. -->
            <columnExists columnName="source_id" tableName="TimeSeries"
                          schemaName="wres" />
            <columnExists columnName="ensemble_id" tableName="TimeSeries"
                          schemaName="wres" />
            <tableExists tableName="Project" schemaName="wres" />
            <tableExists tableName="Source" schemaName="wres" />
            <tableExists tableName="SourceCompleted" schemaName="wres" />
        </preConditions>
        <sql>
            truncate table wres.Project cascade;
            truncate table wres.Source cascade;

            -- This should cascade from wres.Source, but just to be sure...
            truncate table wres.SourceCompleted cascade;
        </sql>
    </changeSet>
    <changeSet id="Remove old wres.TimeSeries table if it exists."
               author="Jesse Bickel">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="TimeSeries" schemaName="wres" />

            <!-- Suppose a new wres.TimeSeries replaces wres.Source, it would
                 not have source_id and would not have ensemble_id in it. -->
            <columnExists columnName="source_id" tableName="TimeSeries" schemaName="wres" />
            <columnExists columnName="ensemble_id" tableName="TimeSeries" schemaName="wres" />
        </preConditions>
        <dropTable tableName="TimeSeries" schemaName="wres" />
    </changeSet>

    <!-- We could rename the table and upgrade the id column to bigint but it
         will allow us to remove a bunch of old changesets by just dropping the
         old and creating the new. And there is one RDBMS that does not support
         table rename (not that we support it anyway). -->

    <changeSet id="Create table wres.TimeSeriesTrace for most database systems."
               author="Jesse Bickel">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="TimeSeriesTrace" schemaName="wres" />
            </not>
        </preConditions>
        <createTable tableName="TimeSeriesTrace" schemaName="wres">
            <column name="timeseriestrace_id" type="bigint" autoIncrement="true"
                    remarks="The synthetic key of the trace represented by this row.">
                <constraints primaryKey="true" primaryKeyName="timeseriestrace_pk"/>
            </column>
            <column name="source_id" type="bigint"
                    remarks="The time series this trace belongs to.">
                <constraints nullable="false" />
            </column>
            <column name="ensemble_id" type="integer"
                    remarks="The ID of the trace metadata.">
                <constraints nullable="false" />
            </column>
        </createTable>
        <comment>
            The wres.TimeSeries table has been added to the database.
        </comment>
    </changeSet>
    <changeSet id="Add unique constraint to wres.TimeSeriesTrace"
               author="Jesse Bickel">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="TimeSeriesTrace" schemaName="wres" />
            <columnExists tableName="TimeSeriesTrace" schemaName="wres"
                          columnName="source_id" />
            <columnExists tableName="TimeSeriesTrace" schemaName="wres"
                          columnName="ensemble_id" />
            <not>
                <indexExists indexName="timeseriestrace_source_ensemble_unique_index"
                             columnNames="source_id,ensemble_id"
                             tableName="TimeSeriesTrace" schemaName="wres" />
            </not>
        </preConditions>
        <addUniqueConstraint constraintName="timeseriestrace_source_ensemble_unique_index"
                             columnNames="source_id,ensemble_id"
                             tableName="TimeSeriesTrace" schemaName="wres" />
    </changeSet>
    <changeSet id="Add source_id foreign key constraint to wres.TimeSeriesTrace (deferred)."
               author="Jesse Bickel"
               dbms="oracle,postgresql,sqlite">
        <preConditions onFail="MARK_RAN">
            <columnExists columnName="source_id"
                          tableName="Source"
                          schemaName="wres" />
            <columnExists columnName="source_id"
                          tableName="TimeSeriesTrace"
                          schemaName="wres" />
            <not>
                <foreignKeyConstraintExists foreignKeyName="timeseriestrace_source_fk"
                                            foreignKeyTableName="TimeSeriesTrace"
                                            schemaName="wres" />
            </not>
        </preConditions>
        <addForeignKeyConstraint baseColumnNames="source_id"
                                 baseTableName="TimeSeriesTrace"
                                 baseTableSchemaName="wres"
                                 constraintName="timeseriestrace_source_fk"
                                 referencedColumnNames="source_id"
                                 referencedTableName="Source"
                                 referencedTableSchemaName="wres"
                                 deferrable="true"
                                 initiallyDeferred="true"
                                 onDelete="CASCADE" />
    </changeSet>

    <changeSet id="Add source_id foreign key constraint to wres.TimeSeriesTrace (non-deferred)."
               author="Jesse Bickel"
               dbms="!oracle,!postgresql,!sqlite,!sybase">
        <preConditions onFail="MARK_RAN">
            <columnExists columnName="source_id"
                          tableName="Source"
                          schemaName="wres" />
            <columnExists columnName="source_id"
                          tableName="TimeSeriesTrace"
                          schemaName="wres" />
            <not>
                <foreignKeyConstraintExists foreignKeyName="timeseriestrace_source_fk"
                                            foreignKeyTableName="TimeSeriesTrace"
                                            schemaName="wres" />
            </not>
        </preConditions>
        <addForeignKeyConstraint baseColumnNames="source_id"
                                 baseTableName="TimeSeriesTrace"
                                 baseTableSchemaName="wres"
                                 constraintName="timeseriestrace_source_fk"
                                 referencedColumnNames="source_id"
                                 referencedTableName="Source"
                                 referencedTableSchemaName="wres"
                                 onDelete="CASCADE" />
    </changeSet>

    <changeSet id="Add ensemble_id foreign key constraint to wres.TimeSeriesTrace (deferred)."
               author="Jesse Bickel"
               dbms="oracle,postgresql,sqlite">
        <preConditions onFail="MARK_RAN">
            <columnExists columnName="ensemble_id"
                          tableName="Ensemble"
                          schemaName="wres" />
            <columnExists columnName="ensemble_id"
                          tableName="TimeSeriesTrace"
                          schemaName="wres" />
            <not>
                <foreignKeyConstraintExists foreignKeyName="timeseriestrace_ensemble_fk"
                                            schemaName="wres" />
            </not>
        </preConditions>
        <addForeignKeyConstraint baseColumnNames="ensemble_id"
                                 baseTableName="TimeSeriesTrace"
                                 baseTableSchemaName="wres"
                                 constraintName="timeseriestrace_ensemble_fk"
                                 referencedColumnNames="ensemble_id"
                                 referencedTableName="Ensemble"
                                 referencedTableSchemaName="wres"
                                 deferrable="true"
                                 initiallyDeferred="true"
                                 onDelete="CASCADE" />
    </changeSet>
    <changeSet id="Add ensemble_id foreign key constraint to wres.TimeSeriesTrace (non-deferred)."
               author="Jesse Bickel"
               dbms="!oracle,!postgresql,!sqlite,!sybase">
        <preConditions onFail="MARK_RAN">
            <columnExists columnName="ensemble_id"
                          tableName="Ensemble"
                          schemaName="wres" />
            <columnExists columnName="ensemble_id"
                          tableName="TimeSeriesTrace"
                          schemaName="wres" />
            <not>
                <foreignKeyConstraintExists foreignKeyName="timeseriestrace_ensemble_fk"
                                            schemaName="wres" />
            </not>
        </preConditions>
        <addForeignKeyConstraint baseColumnNames="ensemble_id"
                                 baseTableName="TimeSeriesTrace"
                                 baseTableSchemaName="wres"
                                 constraintName="timeseriestrace_ensemble_fk"
                                 referencedColumnNames="ensemble_id"
                                 referencedTableName="Ensemble"
                                 referencedTableSchemaName="wres"
                                 onDelete="CASCADE" />
    </changeSet>
</databaseChangeLog>
