<?xml version="1.0" encoding="utf-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.6.xsd"
    objectQuotingStrategy="QUOTE_ONLY_RESERVED_WORDS">
    <changeSet id="Remove data related to LSNO2 and HDGA4 locations from 1.20"
               author="Jesse Bickel">
        <preConditions onFail="MARK_RAN">
            <!-- Find tables used in the sql because tables can die. -->
            <tableExists tableName="TimeSeriesSource" schemaName="wres" />
            <tableExists tableName="ProjectSource" schemaName="wres" />
            <tableExists tableName="Source" schemaName="wres" />
            <tableExists tableName="VariableFeature" schemaName="wres" />
            <tableExists tableName="Feature" schemaName="wres" />
            <tableExists tableName="TimeSeries" schemaName="wres" />
            <tableExists tableName="Project" schemaName="wres" />
            <tableExists tableName="Observation" schemaName="wres" />
            <tableExists tableName="TimeSeriesValue" schemaName="wres" />
            <sqlCheck expectedResult="0">
                select count( lid )
                from wres.Feature
                where ( comid = 21773045 and lid = 'LSNO2' and gage_id = '07190400' and region = 'ABRFC' and state = 'OK' and huc = '11070209' )
                or ( comid = 8588002 and lid = 'HDGA4' and gage_id = '07049000' and region = 'LMRFC' and state = 'AR' and huc = '11010001' );
            </sqlCheck>
        </preConditions>
        <comment>See issue #72786</comment>
        <sqlFile path="20200102_Remove_LSNO2_and_HDGA4_data.sql"
                 splitStatements="false"
                 stripComments="true"
                 relativeToChangelogFile="true" />
    </changeSet>
    <changeSet id="Remove data related to LSNO2 and HDGA4 after 1.20"
               author="Jesse Bickel">
        <preConditions onFail="MARK_RAN">
            <!-- Find tables used in the sql because tables can die. -->
            <not>
                <tableExists tableName="TimeSeriesSource" schemaName="wres" />
            </not>
            <tableExists tableName="ProjectSource" schemaName="wres" />
            <tableExists tableName="Source" schemaName="wres" />
            <tableExists tableName="VariableFeature" schemaName="wres" />
            <tableExists tableName="Feature" schemaName="wres" />
            <tableExists tableName="TimeSeries" schemaName="wres" />
            <tableExists tableName="Project" schemaName="wres" />
            <tableExists tableName="Observation" schemaName="wres" />
            <tableExists tableName="TimeSeriesValue" schemaName="wres" />
            <sqlCheck expectedResult="0">
                select count( lid )
                from wres.Feature
                where ( comid = 21773045 and lid = 'LSNO2' and gage_id = '07190400' and region = 'ABRFC' and state = 'OK' and huc = '11070209' )
                or ( comid = 8588002 and lid = 'HDGA4' and gage_id = '07049000' and region = 'LMRFC' and state = 'AR' and huc = '11010001' );
            </sqlCheck>
        </preConditions>
        <comment>See issue #72786</comment>
        <sqlFile path="20200103_Remove_LSNO2_and_HDGA4_data.sql"
                 splitStatements="false"
                 stripComments="true"
                 relativeToChangelogFile="true" />
    </changeSet>
    <!-- The reason for separating this changeset is there can be a situation
         in the future where one of the above tables is removed, in which case
         neither of the above two changesets will run, however we still want the
         incorrect feature data removed and the correct feature data added, even
         if that causes issues with existing project data (the outcome should
         be that the evaluation no longer has data for these locations). -->
    <changeSet id="Update LSNO2 and HDGA4 locations." author="Jesse Bickel">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="Feature" schemaName="wres" />
            <sqlCheck expectedResult="0">
                select count( lid )
                from wres.Feature
                where ( comid = 21773045 and lid = 'LSNO2' and gage_id = '07190400' and region = 'ABRFC' and state = 'OK' and huc = '11070209' )
                    or ( comid = 8588002 and lid = 'HDGA4' and gage_id = '07049000' and region = 'LMRFC' and state = 'AR' and huc = '11010001' );
            </sqlCheck>
        </preConditions>
        <comment>See issue #72786 and #65216-512</comment>
        <sql splitStatements="false" stripComments="true">
            -- First, delete the feature rows (and cascade).
            delete from wres.Feature
            where lid in ( 'HDGA4', 'LSNO2' );

            -- Second: create new feature rows.
            insert into wres.Feature
            ( comid, lid, gage_id, region, state, huc, feature_name, latitude, longitude )
            values
            ( 21773045, 'LSNO2', '07190400', 'ABRFC', 'OK', '11070209', 'Neosho River (spillway) near Langley, OK', 36.4375, -95.0455555555555555555556 ),
            ( 8588002, 'HDGA4', '07049000', 'LMRFC', 'AR', '11010001', 'War Eagle Creek near Hindsville, AR', 36.2, -93.855 );
        </sql>
    </changeSet>
</databaseChangeLog>
