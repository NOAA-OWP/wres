<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                      http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd"
        objectQuotingStrategy="QUOTE_ONLY_RESERVED_WORDS">
    <changeSet id="Fix VariableFeature PK" author="Christopher Tubbs" dbms="PostgreSQL" >
        <preConditions onFail="MARK_RAN">
            <and>
                <sequenceExists sequenceName="variablefeature_variablefeature_id_seq" schemaName="wres" />
                <sqlCheck expectedResult="t">
                    <![CDATA[
                    SELECT currval('wres.variablefeature_variablefeature_id_seq') < MAX(variablefeature_id)
                    FROM wres.VariableFeature
                    ]]>
                </sqlCheck>
            </and>
        </preConditions>
        <sql>
            SELECT setval('wres.variablefeature_variablefeature_id_seq',
                (
                    SELECT GREATEST(
                        MAX(variablefeature_id) + 1,
                        nextval('wres.variablefeature_variablefeature_id_seq')
                    ) - 1
                    FROM wres.VariableFeature
                )
            );
        </sql>
        <comment>
            The sequence for wres.VariableFeature is up to date.
        </comment>
    </changeSet>
</databaseChangeLog>