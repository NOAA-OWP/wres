version: '2.3'
networks:
    wres_net:
        driver: bridge
        enable_ipv6: false
        ipam:
            driver: default
            config:
                - subnet: 172.19.254.192/26
                  gateway: 172.19.254.193
volumes:
    home:
        driver_opts:
            type: "nfs"
            o: "ro,relatime,vers=4.1,rsize=1048576,wsize=1048576,namlen=255,hard,proto=tcp,timeo=600,retrans=2,sec=sys,local_lock=none,addr=${NFS_HOME_DIR_IP_ADDRESS}"
            device: "${NFS_HOME_DIR_DEVICE}"
    wres_share_job_data:
        driver_opts:
            type: "nfs"
            o: "rw,relatime,vers=3,rsize=65536,wsize=65536,namlen=255,hard,proto=tcp,timeo=600,retrans=2,sec=sys,local_lock=none,addr=${NFS_WRES_SHARE_DIR_IP_ADDRESS}"
            device: "${NFS_WRES_SHARE_DIR_DEVICE}/job_data"
    wres_share_evaluations:
        driver_opts:
            type: "nfs"
            o: "rw,relatime,vers=3,rsize=65536,wsize=65536,namlen=255,hard,proto=tcp,timeo=600,retrans=2,sec=sys,local_lock=none,addr=${NFS_WRES_SHARE_DIR_IP_ADDRESS}"
            device: "${NFS_WRES_SHARE_DIR_DEVICE}/evaluations"
    wres_share_input_data_ro:
        driver_opts:
            type: "nfs"
            o: "ro,relatime,vers=3,rsize=65536,wsize=65536,namlen=255,hard,proto=tcp,timeo=600,retrans=2,sec=sys,local_lock=none,addr=${NFS_WRES_SHARE_DIR_IP_ADDRESS}"
            device: "${NFS_WRES_SHARE_DIR_DEVICE}/input_data"
    wres_share_heap_dumps_tasker:
        driver_opts:
            type: "nfs"
            o: "rw,relatime,vers=3,rsize=65536,wsize=65536,namlen=255,hard,proto=tcp,timeo=600,retrans=2,sec=sys,local_lock=none,addr=${NFS_WRES_SHARE_DIR_IP_ADDRESS}"
            device: "${NFS_WRES_SHARE_DIR_DEVICE}/heap_dumps/tasker"
    wres_share_systests:
        driver_opts:
            type: "nfs"
            o: "ro,relatime,vers=3,rsize=65536,wsize=65536,namlen=255,hard,proto=tcp,timeo=600,retrans=2,sec=sys,local_lock=none,addr=${NFS_WRES_SHARE_DIR_IP_ADDRESS}"
            device: "${NFS_WRES_SHARE_DIR_DEVICE}/systests"
    wres_share_heap_dumps_worker-shim:
        driver_opts:
            type: "nfs"
            o: "rw,relatime,vers=3,rsize=65536,wsize=65536,namlen=255,hard,proto=tcp,timeo=600,retrans=2,sec=sys,local_lock=none,addr=${NFS_WRES_SHARE_DIR_IP_ADDRESS}"
            device: "${NFS_WRES_SHARE_DIR_DEVICE}/heap_dumps/worker-shim"
    wres_share_heap_dumps_wres:
        driver_opts:
            type: "nfs"
            o: "rw,relatime,vers=3,rsize=65536,wsize=65536,namlen=255,hard,proto=tcp,timeo=600,retrans=2,sec=sys,local_lock=none,addr=${NFS_WRES_SHARE_DIR_IP_ADDRESS}"
            device: "${NFS_WRES_SHARE_DIR_DEVICE}/heap_dumps/wres"
    wres_share_heap_dumps_eventsbroker:
        driver_opts:
            type: "nfs"
            o: "rw,relatime,vers=3,rsize=65536,wsize=65536,namlen=255,hard,proto=tcp,timeo=600,retrans=2,sec=sys,local_lock=none,addr=${NFS_WRES_SHARE_DIR_IP_ADDRESS}"
            device: "${NFS_WRES_SHARE_DIR_DEVICE}/heap_dumps/eventsbroker"
    wres_share_heap_dumps_graphics:
        driver_opts:
            type: "nfs"
            o: "rw,relatime,vers=3,rsize=65536,wsize=65536,namlen=255,hard,proto=tcp,timeo=600,retrans=2,sec=sys,local_lock=none,addr=${NFS_WRES_SHARE_DIR_IP_ADDRESS}"
            device: "${NFS_WRES_SHARE_DIR_DEVICE}/heap_dumps/graphics"
services:
    worker:
        image: "${DOCKER_REGISTRY}/wres/wres-worker:20210817-b31ec6d"
        restart: always
        depends_on:
            eventsbroker:
                condition: service_started
        volumes:
         # To write user output data:
         - wres_share_evaluations:/mnt/wres_share/evaluations
         # To read user input using read-only nfs mount above:
         - home:/home:ro
         # To read user input data written by tasker:
         - wres_share_input_data_ro:/mnt/wres_share/input_data:ro
         # To read test input data:
         - wres_share_systests:/mnt/wres_share/systests:ro
         # For certificates, keys that correspond to them, and .pgpass:
         - /mnt/wres_keys:/wres_secrets:ro
         # To write heap dumps (worker-shim process):
         - wres_share_heap_dumps_worker-shim:/mnt/wres_share/heap_dumps/worker-shim
         # To write heap dumps (core WRES process):
         - wres_share_heap_dumps_wres:/mnt/wres_share/heap_dumps/wres
         # For logs (inside container, avoid writing to read-only /home)
         - /container_home
        environment:
         - JAVA_OPTS=-Dwres.broker=${WRES_BROKER_HOST} -Djava.io.tmpdir=/mnt/wres_share/evaluations -XX:OnOutOfMemoryError='mv /mnt/wres_share/heap_dumps/worker-shim/java_pid%p.hprof /mnt/wres_share/heap_dumps/worker-shim/java_pid%p_`hostname`.hprof; chmod 775 /mnt/wres_share/heap_dumps/worker-shim/java_pid%p_`hostname`.hprof'
         - PGPASSFILE=/wres_secrets/.pgpass
         # Use caller-specified db hostname from env var WRES_DB_FQDN.
         # Do not auto-liquibase-migrate on each evaluation. This requires an
         # administrator to run the migration(s) during or after deployment.
         # Write heap dumps to the root of the volume above.
         # Override the broker address and port in the binding URL of the event.properties.
         - INNER_JAVA_OPTS=-Dwres.eventsBrokerAddress=eventsbroker -Dwres.eventsBrokerPort=5673 -Dwres.externalGraphics=true -Djava.io.tmpdir=/mnt/wres_share/evaluations -Dwres.databaseHost=${WRES_DB_FQDN} -Dwres.databaseName=wres8 -Dwres.username=wres_user8 -Dwres.attemptToMigrate=false -XX:HeapDumpPath=/mnt/wres_share/heap_dumps/wres -XX:OnOutOfMemoryError='mv /mnt/wres_share/heap_dumps/wres/java_pid%p.hprof /mnt/wres_share/heap_dumps/wres/java_pid%p_`hostname`.hprof; chmod 775 /mnt/wres_share/heap_dumps/wres/java_pid%p_`hostname`.hprof' -XX:StartFlightRecording=settings=wres_jfr,maxsize=128m,dumponexit=true,filename=/mnt/wres_share/heap_dumps/wres/`date +%Y%m%dT%H%M%S.%NZ --utc`.jfr -XX:FlightRecorderOptions=repository=/mnt/wres_share/heap_dumps/wres/
        # Shim JVM should have 32m max heap, core JVM should have 1680m max heap
        mem_limit: 2814m
        cap_drop:
         - ALL
        read_only: true
        networks:
            wres_net:
    eventsbroker:
        expose:
         - 5673
        ports:
         - 15673:15673
        image: "${DOCKER_REGISTRY}/wres/wres-eventsbroker:20210816-f31dd7a"
        restart: always
        volumes:
         # For heap-dump files
         - wres_share_heap_dumps_eventsbroker:/mnt/wres_share/heap_dumps/eventsbroker
         # For certificates and keys that correspond to them
         - /mnt/wres_keys:/wres_secrets:ro
        environment:
         # The broker uses heap memory to run and direct memory for messages
         - QPID_WORK=/container_home
         - QPID_JAVA_MEM=-Xms256m -Xmx256m -XX:MaxDirectMemorySize=2048m
         - QPID_JAVA_GC=-XX:+UseConcMarkSweepGC
         - JAVA_OPTS=-XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/mnt/wres_share/heap_dumps/eventsbroker
        # Broker heap plus direct memory is 2304m in QPID_JAVA_MEM
        mem_limit: 2560m
        cap_drop:
         - ALL
        read_only: true
        networks:
            wres_net:
    graphics:
        depends_on:
            eventsbroker:
                condition: service_started
        image: "${DOCKER_REGISTRY}/wres/wres-graphics:20210816-f31dd7a"
        restart: always
        volumes:
         # To write graphics outputs
         - wres_share_evaluations:/mnt/wres_share/evaluations
         # To write heap dumps
         - wres_share_heap_dumps_graphics:/mnt/wres_share/heap_dumps/graphics
        environment:
         # Override the broker address and port in the binding URL of the event.properties
         - JAVA_OPTS=-Dwres.eventsBrokerAddress=eventsbroker -Dwres.eventsBrokerPort=5673 -Djava.io.tmpdir=/mnt/wres_share/evaluations -Xms640m -Xmx640m -XX:HeapDumpPath=/mnt/wres_share/heap_dumps/graphics -XX:OnOutOfMemoryError='mv /mnt/wres_share/heap_dumps/graphics/java_pid%p.hprof /mnt/wres_share/heap_dumps/graphics/java_pid%p_`hostname`.hprof; chmod 775 /mnt/wres_share/heap_dumps/graphics/java_pid%p_`hostname`.hprof' -XX:StartFlightRecording=name=graphics,maxsize=256m,disk=true,maxage=24h,dumponexit=true,filename=/mnt/wres_share/heap_dumps/graphics/`hostname`/`date +%Y%m%dT%H%M%S.%NZ --utc`.jfr -XX:FlightRecorderOptions=repository=/mnt/wres_share/heap_dumps/graphics/`hostname`
        # Graphics limit is 640m in JAVA_OPTS
        mem_limit: 1024m
        cap_drop:
         - ALL
        read_only: true
        networks:
            wres_net:
